server {
    listen 3000;
    
    # Отключение кэширования для всего сервера
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "Mon, 01 Jan 1990 00:00:00 GMT" always;
    etag off;
    if_modified_since off;
    expires off;
    
    # Увеличение буферов и таймаутов
    client_max_body_size 50M;
    client_body_buffer_size 50M;
    client_body_timeout 120s;
    client_header_timeout 120s;
    keepalive_timeout 120s;
    send_timeout 120s;
    
    # Корневой маршрут - перенаправление на /mobileapp/
    location = / {
        return 301 /mobileapp/;
    }
    
    location /mobileapp {
        alias /usr/share/nginx/html/mobileapp;
        try_files $uri $uri/ /mobileapp/index.html;
        index index.html index.htm;
        
        # Отключение кэширования для HTML файлов
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Expires "Mon, 01 Jan 1990 00:00:00 GMT" always;
        expires off;
        etag off;
        if_modified_since off;
    }
    
    location ~* /mobileapp/index\.html$ {
        alias /usr/share/nginx/html/mobileapp/index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "Mon, 01 Jan 1990 00:00:00 GMT" always;
        expires off;
        etag off;
        if_modified_since off;
    }
    
    # Полностью отключаем кэширование для всех статических файлов
    location /mobileapp/static {
        alias /usr/share/nginx/html/mobileapp/static;
        
        # Отключение кэширования для CSS, JS и других статических файлов
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "Mon, 01 Jan 1990 00:00:00 GMT" always;
        expires off;
        etag off;
        if_modified_since off;
        
        # Добавляем случайный параметр к URL файлов CSS и JS для принудительного обновления
        location ~* \.(css|js)$ {
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires "Mon, 01 Jan 1990 00:00:00 GMT" always;
            expires off;
            etag off;
            if_modified_since off;
        }
    }
    
    location = /mobileapp {
        return 301 /mobileapp/;
    }
    
    location /api/ {
        proxy_pass http://mobileapp_backend:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_no_cache 1;
        
        # Увеличение таймаутов для API запросов
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # Отключение кэширования
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "Mon, 01 Jan 1990 00:00:00 GMT" always;
    }
    
    # Для обработки ошибок
    error_page 404 = /mobileapp/index.html;
}
